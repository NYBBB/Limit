# Limit 2.0 功能说明文档

## 项目简介

**Limit** 是一款基于 WinUI 3 的智能疲劳管理助手，通过实时监测用户的应用使用情况、计算疲劳值，并提供智能干预建议，帮助用户保持健康的工作节奏。

**版本**: 2.0  
**技术栈**: C# / WinUI 3 / .NET 8 / LiveCharts2 / SQLite

---

## 核心系统

### 1. 疲劳值计算引擎（FatigueEngine）

**功能**：实时计算用户的疲劳值（0-100%）

**核心特性**：
- **动态疲劳率**：根据当前应用类型动态调整疲劳上升速率
- **上下文感知**：不同类型的应用有不同的疲劳贡献率
  - 工作类应用（如 IDE、Word）：LoadWeight = 1.0
  - 娱乐类应用（如游戏、视频）：LoadWeight = 0.6
  - 沟通类应用（如微信、Teams）：LoadWeight = 0.8
  - 其他应用：LoadWeight = 0.7
- **恢复机制**：用户空闲时自动恢复疲劳值
- **斜率计算**：实时追踪疲劳值变化趋势（Slope）

**疲劳状态分级**：
- **Fresh（清新）**: 0-40%
- **Strained（紧张）**: 40-60%
- **Overloaded（过载）**: 60-80%
- **Grind（极限）**: 80-100%

---

### 2. 上下文分类系统（ContextClassifier）

**功能**：智能识别应用和网站的类型

**分类维度**：
- **Work（工作/学习）**: IDE、Office、PDF阅读器、学习平台
- **Entertainment（娱乐）**: 视频网站、游戏、音乐播放器
- **Communication（沟通）**: 即时通讯、邮件、会议软件
- **Other（其他）**: 未分类应用

**识别技术**：
- 应用进程名识别
- 浏览器 URL 域名匹配（100+ 网站规则）
- 页面标题关键词匹配
- 使用 FlaUI 自动化提取浏览器 URL

---

### 3. 预测系统（ForecastService）

**功能**：预测用户疲劳度达到阈值的剩余时间

**核心算法**：
- **TTE (Time To Exhaustion)**: 计算当前负载下达到枯竭的时间
- **斜率预测**：基于近期疲劳值变化趋势预测
- **多场景计算**：
  - 当前负载下的预计时间
  - 低负载（如切换到娱乐应用）下的延长时间

**应用场景**：
- Dashboard 的"枯竭倒计时"卡片
- "延长建议"面板（建议切换到低负载活动）

---

### 4. 干预系统（InterventionPolicy）

**功能**：根据疲劳值智能推送休息提醒

**干预级别**：
| 疲劳值 | 级别 | 行为 |
|--------|------|------|
| 60-70% | Nudge（轻推） | 卡片提示 |
| 70-80% | Suggestion（建议） | 卡片 + 橙色边框 |
| 80%+ | Intervention（干预） | 卡片 + 红色边框 + Toast通知 |

**冷却机制**：
- 每次干预后15分钟冷却期，避免频繁打扰

**交互方式**：
- Dashboard 干预卡片（橙色/红色边框）
- Windows Toast 通知
- 系统托盘气泡提示

---

### 5. Break Tasks 系统（BreakTaskService）

**功能**：任务化休息，提供可追踪的休息任务

**任务类型**：
- **MobilityTask（活动任务）**: 连续工作 > 20分钟触发，建议站起来活动
- **EyeTask（护眼任务）**: 长时间盯屏幕，建议闭眼休息
- **StretchTask（拉伸任务）**: 久坐提醒

**任务流程**：
1. 触发条件满足 → 生成任务
2. Dashboard 显示任务卡片
3. 用户点击"开始休息" → 弹出全屏休息弹窗
4. 完成/忽略 → 记录到数据库

**数据记录**：
- 任务类型、触发时间
- 用户响应（完成/忽略/跳过）
- 持续时长

---

## 界面功能

### 界面 1：Dashboard（今日）

**定位**：主控制面板，实时监控当前状态

**核心组件**：

#### 1.1 疲劳度卡片
- **大号进度环**：显示当前疲劳值（0-100%）
- **颜色编码**：
  - 绿色：0-40%
  - 黄色：40-60%
  - 橙色：60-80%
  - 红色：80%+
- **疲劳状态文字**：Fresh/Strained/Overloaded/Grind

#### 1.2 枯竭预测卡片
- **倒计时显示**：距离枯竭（80%）的剩余时间
- **斜率指示**：疲劳值变化趋势（上升/下降/平稳）

#### 1.3 延长建议面板
- **建议内容**：切换到低负载活动可延长的时间
- **场景示例**："切换到娱乐活动可延长 +XX 分钟"

#### 1.4 干预提醒卡片
- **动态显示**：仅在疲劳值 ≥ 60% 时出现
- **边框颜色**：橙色（70%以下）/ 红色（80%+）
- **快捷按钮**："休息一下"直接触发休息弹窗

#### 1.5 Break Task 卡片
- **任务信息**：任务类型、触发原因、建议时长
- **操作按钮**：已完成 / 忽略

#### 1.6 今日使用面板
- **树形结构**：
  - 顶层：应用列表（按使用时长排序）
  - 二层：浏览器网站列表（可展开/折叠）
  - 三层：网站页面标题列表（可展开/折叠）
- **数据展示**：应用名、使用时长、占比进度条
- **展开/收起**：默认显示前 4-5 个应用，可展开查看全部

#### 1.7 疲劳度趋势图
- **图表类型**：LiveCharts2 CartesianChart（折线图）
- **X轴**：时间（24小时）
- **Y轴**：疲劳值（0-100%）
- **数据**：实时疲劳值快照
- **Tooltip**：悬浮显示具体时间点的疲劳值

#### 1.8 开发者调试面板
- **用户状态**：Active / Idle
- **当前疲劳值**：实时数值
- **疲劳斜率**：Slope 值
- **当前上下文**：Work / Entertainment / Communication
- **下次建议**：下一次 Break Task 触发时间
- **调试滑块**：手动设置疲劳值（测试干预系统）

---

### 界面 2：Analytics（分析）

**定位**：历史数据分析与可视化

**核心组件**：

#### 2.1 日期选择器
- **快捷按钮**：今日 / 昨日
- **日期选择器**：可选择任意历史日期

#### 2.2 疲劳度趋势图
- **图表类型**：折线图
- **数据源**：选定日期的疲劳值快照
- **X轴**：小时（0-24）
- **Y轴**：疲劳值（0-100%）
- **用途**：查看某一天的疲劳变化曲线

#### 2.3 24小时应用使用分布
- **图表类型**：堆叠柱状图（Stacked ColumnSeries）
- **数据维度**：
  - X轴：24小时（每小时一个柱子）
  - Y轴：使用时长（分钟）
  - 颜色分层：前8个最常用应用 + "其他"类别
- **Tooltip**：悬浮显示该小时内各应用的使用时长
- **用途**：直观了解全天应用使用模式

#### 2.4 🥧 Energy Pie（精力分布饼图）
- **图表类型**：饼图（PieSeries）
- **数据分类**：
  - **工作/学习**（紫色）：IDE、Office、学习平台
  - **娱乐**（橙色）：视频、游戏、音乐
  - **沟通**（蓝色）：聊天、邮件、会议
  - **其他**（灰色）：未分类应用
- **显示内容**：
  - 每个类别的时间占比
  - 总活跃时间
- **用途**：了解时间分配是否平衡

#### 2.5 🔥 The Grind（高强度工作统计）
- **展示内容**：
  - **今日最长连续工作**：最长的连续非低疲劳时段（分钟）
  - **过载时间**：疲劳值 ≥ 80% 的累计时长（分钟）
  - **过载占比**：过载时间占总活跃时间的百分比
- **可视化**：大号数字 + 进度条（红色）
- **用途**：识别"工作过度"行为

#### 2.6 📊 Daily Rhythm（日节奏图）
- **图表类型**：区域折线图（LineSeries with Fill）
- **数据**：24小时疲劳曲线
- **X轴**：时间（0:00 - 24:00，2小时间隔）
- **Y轴**：疲劳值（0-100%）
- **特点**：
  - 平滑曲线（LineSmoothness = 0.5）
  - 半透明填充区域
  - 紫色主题
- **用途**：识别一天中的疲劳高峰和低谷时段

#### 2.7 📈 Weekly Trends（周趋势）
- **图表类型**：分组柱状图（Grouped ColumnSeries）
- **数据**：过去7天的疲劳数据
- **对比维度**：
  - **峰值**（橙色柱）：当天最高疲劳值
  - **平均值**（紫色柱）：当天平均疲劳值
- **X轴**：日期（MM/dd 格式）
- **Y轴**：疲劳值（0-100%）
- **用途**：
  - 识别每周工作强度变化
  - 对比工作日 vs 周末的疲劳模式

---

### 界面 3：Rules（规则）

**定位**：自定义应用分类规则

**功能**（待实现）：
- 自定义应用的上下文分类
- 添加/编辑网站域名规则
- 设置特定应用的疲劳贡献率

---

### 界面 4：Settings（设置）

**定位**：应用配置与偏好设置

**配置项**：

#### 4.1 通用设置
- **最小化到托盘**：关闭窗口时最小化到系统托盘
- **开机自动启动**：Windows 启动时自动运行 Limit

#### 4.2 数据持久化设置
- **疲劳快照间隔**：保存疲劳值到数据库的频率（秒）
- **图表数据间隔**：图表展示用的数据采样频率（分钟）
- **Dashboard 刷新间隔**：界面刷新频率（秒）

#### 4.3 快捷键设置（待实现）
- 快速显示/隐藏窗口
- 开始/暂停监测
- 触发快速休息

---

## 系统集成功能

### 1. 系统托盘（TrayIconService）

**功能**：
- **托盘图标**：常驻系统托盘
- **动态提示**：悬浮显示当前疲劳状态
- **右键菜单**：
  - 显示主窗口
  - 开始监测
  - 暂停监测
  - 退出应用

**交互**：
- 右键点击 → 显示菜单
- 关闭主窗口 → 最小化到托盘（不退出）

---

### 2. Toast 通知（ToastNotificationService）

**功能**：Windows 原生通知集成

**触发场景**：
- **干预提醒**：疲劳值 ≥ 60% 时推送
- **Break Task 触发**：新任务产生时推送
- **窗口最小化提示**：首次最小化到托盘时提示

**通知内容**：
- 标题：疲劳提醒 / 休息任务
- 正文：具体提示内容
- 按钮：休息一下 / 稍后提醒

---

### 3. 开机自启动（AutoStartService）

**实现方式**：注册表（`HKEY_CURRENT_USER\...\Run`）

**控制**：
- 通过设置页面的开关控制
- 自动检测当前启用状态

---

## 数据持久化

### 数据库架构（SQLite）

#### 表 1: HourlyUsageRecord（每小时使用记录）
- **字段**：日期、小时、应用名、URL、时长（秒）
- **用途**：应用使用分布图、精力分布图

#### 表 2: FatigueSnapshot（疲劳值快照）
- **字段**：记录时间、疲劳值
- **用途**：疲劳趋势图、日节奏图、周趋势图

#### 表 3: BreakTaskRecord（休息任务记录）
- **字段**：任务类型、触发时间、完成状态、持续时长
- **用途**：休息行为分析、任务完成率统计

---

## 技术亮点

### 1. 实时窗口追踪
- 使用 Windows API 获取活动窗口
- FlaUI 自动化提取浏览器地址栏 URL
- 5秒缓存机制优化性能

### 2. 空闲检测
- `GlobalInputMonitor` 监听全局鼠标/键盘输入
- 60秒无输入视为空闲
- 空闲时停止记录使用时长，开始疲劳恢复

### 3. 图表渲染
- LiveCharts2 高性能数据可视化
- 自定义中文字体支持（Microsoft YaHei）
- 响应式布局适配不同分辨率

### 4. MVVM 架构
- CommunityToolkit.Mvvm 简化 ViewModel
- 依赖注入（DI）管理服务生命周期
- 单例模式确保数据一致性

---

## 未来规划

### Phase 6 待实现
- **ROI 矩阵**：散点图显示应用的"时间投入 vs 精力消耗"

### 性能优化
- 减少 UI 线程阻塞
- 数据库查询索引优化
- 图表渲染性能提升

### 新功能
- **专注模式**：免打扰模式 + 番茄钟
- **目标系统**：每日/每周疲劳目标
- **成就系统**：连续健康天数徽章
- **云同步**：多设备数据同步（OneDrive/Google Drive）

---

## 总结

Limit 2.0 是一款功能完善的智能疲劳管理助手，通过：
- **实时监测**：准确追踪应用使用和疲劳值
- **智能分析**：上下文分类、预测、干预
- **丰富可视化**：7种图表全方位展示数据
- **任务化休息**：可追踪的健康行为培养

帮助用户建立健康的工作节奏，预防过度疲劳。
