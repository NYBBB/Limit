# Limit 3.0 实施计划

## 项目背景

Limit 2.0 已完成所有核心功能。3.0 版本将进行重大升级，核心理念从"疲劳计算器"升级为**静默科技 (Quiet Technology)** —— 不打扰的心流守护者。

### 2.0 → 3.0 主要变更

| 模块 | 2.0 现状 | 3.0 目标 |
|------|----------|----------|
| **算法** | Time × Weight 线性逻辑 | Empathy Engine（主观校准 + Cluster） |
| **Dashboard** | 传统卡片列表布局 | Bento Grid 便当盒布局 |
| **干预** | 固定阈值触发 | 分级干预 Ladder + 摩擦力设计 |
| **数据** | 无限累积 | 热/冷数据分层 + 聚合压缩 |

---

## 用户审核事项

> [!IMPORTANT]
> **开发策略选择**: 建议采用**渐进式重构**而非完全重写，保留 2.0 代码作为基础，逐步替换/升级模块。

> [!WARNING]
> **破坏性变更**: Dashboard 布局将完全重新设计，2.0 的 `DashboardPage.xaml` 建议重命名为 `DashboardPage_v2.xaml` 备份。

---

## 开发阶段规划

### Phase 1: 核心算法引擎 (Empathy Engine)

#### [MODIFY] [FatigueEngine.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/FatigueEngine.cs)
- 新增 `SensitivityBias` 属性（0.0 ~ 1.0）
- 新增 `IsCareMode` 状态标志
- 修改疲劳计算公式：`dF/dt = BaseRate × (1 + SensitivityBias) × LoadWeight`
- 添加每小时 5% 衰减逻辑

#### [NEW] [Cluster.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Core/Entities/Cluster.cs)
```csharp
public class Cluster
{
    [PrimaryKey, AutoIncrement]
    public int Id { get; set; }
    public string Name { get; set; }           // "Coding", "Writing" 等
    public string AppListJson { get; set; }    // 序列化的应用列表
    public bool IsSystemPreset { get; set; }   // 是否为系统预设
}
```

#### [NEW] [ClusterService.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/ClusterService.cs)
- 管理 Cluster 的 CRUD 操作
- 提供 `GetClusterForApp(string processName)` 方法
- 预设系统 Clusters

#### [MODIFY] [ContextClassifier.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/ContextClassifier.cs)
- 集成 ClusterService
- 新增 `ContextSwitchPenalty` 计算（簇内=0，簇外>0）

#### [MODIFY] [UserActivityManager.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/UserActivityManager.cs)
- 修复"看视频被当成空闲"问题
- 新增 `PassiveConsumption` 状态判定

---

### Phase 2: Dashboard 3.0 (Bento Grid)

#### [NEW] [DashboardPage3.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Views/DashboardPage3.xaml)
全新 Bento Grid 布局：
```
┌─────────────────┬─────────────┐
│                 │   Zone B    │
│     Zone A      │  Context    │
│   (The Core)    ├─────────────┤
│                 │   Zone C    │
│                 │  Drainers   │
└─────────────────┴─────────────┘
```

#### [NEW] [FatigueRing.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Controls/FatigueRing.xaml)
自定义控件：
- 12px 线宽圆环
- 呼吸动效（Storyboard 无限循环）
- 动态颜色切换
- Care Mode 指示器

#### [NEW] [ContextCard.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Controls/ContextCard.xaml)
Zone B 组件：
- 当前应用图标 + Cluster 名称
- Focusing/Chilling 切换开关

#### [NEW] [DrainersCard.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Controls/DrainersCard.xaml)
Zone C 组件：
- Top 3 消耗排行
- 碎片时间警示条目

#### [NEW] [DashboardViewModel3.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/ViewModels/DashboardViewModel3.cs)
新版 ViewModel 支持 Bento 布局数据绑定

---

### Phase 3: Analytics 3.0

#### [MODIFY] [AnalyticsPage.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Views/AnalyticsPage.xaml)
- 新增 Insight Banner 区域
- 新增 Heatmap 组件
- 新增 Workflow Timeline 组件
- 迁移 2.0 图表到可折叠 "Summary" 区域

#### [NEW] [HeatmapControl.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Controls/HeatmapControl.xaml)
7天 × 24小时热力图：
- 基于 Grid 的自定义绘制
- 动态颜色映射
- Hover Tooltip

#### [NEW] [TimelineControl.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Controls/TimelineControl.xaml)
工作流时间轴：
- 垂直布局
- Cluster Line 连接逻辑

---

### Phase 4: Rules & Settings 3.0

#### [MODIFY] [RulesPage.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Views/RulesPage.xaml)
- 新增 Cluster Editor Tab
- 实现拖拽分类交互

#### [NEW] [ClusterEditorControl.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Controls/ClusterEditorControl.xaml)
桶交互组件：
- 左侧未分类应用池
- 右侧 Cluster 桶
- 拖拽 + 右键菜单

---

### Phase 5: 干预系统升级

#### [MODIFY] [InterventionPolicy.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/InterventionPolicy.cs)
- 重构为三级干预：L1 Ambient / L2 Nudge / L3 Hard Stop
- L2 添加"走神检测"触发条件

#### [MODIFY] [BreakOverlayWindow.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Views/BreakOverlayWindow.xaml)
- 更新文案为 "Diminishing Returns"
- 实现长按 3 秒解锁交互
- 按钮改为 "Step Away" / "I Must Finish"

#### [NEW] [MorningBriefingWindow.xaml](file:///e:/Desk/EyeGuard/src/EyeGuard.UI/Views/MorningBriefingWindow.xaml)
晨报弹窗：
- Modal 卡片样式
- 昨日评分 + 关键数据
- SlideUp 入场动画

#### [NEW] [MorningBriefingService.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/MorningBriefingService.cs)
- 检测新一天首次活跃
- 生成昨日总结数据
- Toast 提示逻辑

---

### Phase 6: 数据架构优化

#### [NEW] [DailyAggregateRecord.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Core/Entities/DailyAggregateRecord.cs)
```csharp
public class DailyAggregateRecord
{
    [PrimaryKey, AutoIncrement]
    public int Id { get; set; }
    public DateTime Date { get; set; }
    public int TotalActiveMinutes { get; set; }
    public double PeakFatigue { get; set; }
    public int ScatteredMinutes { get; set; }      // 碎片时间
    public string ClusterDistributionJson { get; set; }
}
```

#### [NEW] [DataAggregationService.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/DataAggregationService.cs)
- 每日闲时自动执行聚合
- 压缩 7 天前的详细记录
- 保留关键统计指标

#### [MODIFY] [DatabaseService.cs](file:///e:/Desk/EyeGuard/src/EyeGuard.Infrastructure/Services/DatabaseService.cs)
- 新增 `DailyAggregateRecord` 表
- 新增 `Cluster` 表
- 添加聚合相关方法

---

## 验证计划

### 自动化测试
> [!CAUTION]
> 当前项目**未发现现有测试项目**。建议后续添加单元测试。

### 手动验证

#### Phase 1 验证：算法引擎
1. 启动应用，打开 Dashboard
2. 点击"我觉得很累" → 确认 Care Mode 激活（UI 有视觉变化）
3. 等待 1 小时 → 确认敏感度衰减（可通过调试面板查看）

#### Phase 2 验证：Dashboard 3.0
1. 启动应用 → 确认 Bento Grid 布局正确渲染
2. Zone A 圆环应有呼吸动效
3. Zone B 显示当前应用 → 切换应用 → 确认更新
4. Zone C Top 3 列表 → 确认按消耗排序

#### Phase 3 验证：Analytics
1. 导航到 Analytics 页面
2. 热力图应显示过去 7 天数据
3. 时间轴应显示今日 Cluster 连续性
4. Summary 区域折叠/展开正常

#### Phase 5 验证：Overlay 3.0
1. 手动将疲劳值设置为 85%（调试滑块）
2. 触发 Overlay → 文案应为 "Diminishing Returns"
3. 点击 "I Must Finish" → 需长按 3 秒才能关闭

---

## 开发顺序建议

```
Phase 1 (引擎) → Phase 2 (Dashboard UI) → Phase 5 (干预) → Phase 3 (Analytics) → Phase 4 (Rules) → Phase 6 (数据)
```

**理由**: 
- Phase 1 提供算法基础
- Phase 2 + 5 是用户最常接触的界面，优先完成
- Phase 3/4/6 可并行或后续迭代
