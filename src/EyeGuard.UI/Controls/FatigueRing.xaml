<?xml version="1.0" encoding="utf-8"?>

<!-- 
    FatigueRing.xaml - Limit 3.0 精力反应堆核心控件
    Zone A: The Core - 双环呼吸动效 (Phase 9 重设计)
    支持单环(疲劳)和双环(疲劳+专注倒计时)模式
-->
<UserControl
    x:Class="EyeGuard.UI.Controls.FatigueRing"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:EyeGuard.UI.Controls">

    <UserControl.Resources>
        <!-- 呼吸动画 Storyboard - 作用于整个圆环容器 -->
        <Storyboard x:Name="BreathingAnimation" RepeatBehavior="Forever" AutoReverse="True">
            <DoubleAnimation 
                Storyboard.TargetName="RingContainer"
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                From="0.97" To="1.03" 
                Duration="0:0:2">
                <DoubleAnimation.EasingFunction>
                    <SineEase EasingMode="EaseInOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation 
                Storyboard.TargetName="RingContainer"
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                From="0.97" To="1.03" 
                Duration="0:0:2">
                <DoubleAnimation.EasingFunction>
                    <SineEase EasingMode="EaseInOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <!-- 弧线粗细呼吸 -->
            <DoubleAnimation 
                Storyboard.TargetName="InnerArcPath"
                Storyboard.TargetProperty="StrokeThickness"
                From="20" To="28" 
                Duration="0:0:2">
                <DoubleAnimation.EasingFunction>
                    <SineEase EasingMode="EaseInOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>
    </UserControl.Resources>

    <!-- Phase 9: 使用 Viewbox 让圆环自适应容器大小 -->
    <Viewbox Stretch="Uniform" MaxWidth="400" MaxHeight="400">
        <Grid x:Name="RingContainer" Width="300" Height="300" RenderTransformOrigin="0.5,0.5">
            <Grid.RenderTransform>
                <ScaleTransform ScaleX="1" ScaleY="1"/>
            </Grid.RenderTransform>
            
            <!-- ===== 外环 (专注倒计时) - 双环模式显示 ===== -->
            <Canvas x:Name="OuterRingCanvas" 
                    Width="300" Height="300"
                    Visibility="{x:Bind OuterRingVisibility, Mode=OneWay}">
                <!-- 外环轨道 -->
                <Ellipse Width="290" Height="290"
                         Canvas.Left="5" Canvas.Top="5"
                         Stroke="{ThemeResource ControlStrongStrokeColorDefaultBrush}"
                         StrokeThickness="12"
                         Opacity="0.1"
                         Fill="Transparent"/>
                <!-- 外环进度弧 -->
                <Path x:Name="OuterArcPath"
                      Stroke="{x:Bind OuterRingColor, Mode=OneWay}"
                      StrokeThickness="12"
                      StrokeStartLineCap="Round"
                      StrokeEndLineCap="Round"
                      Fill="Transparent">
                    <Path.Data>
                        <PathGeometry>
                            <PathFigure x:Name="OuterArcFigure" StartPoint="150,5">
                                <ArcSegment x:Name="OuterArcSegment"
                                            Size="145,145"
                                            SweepDirection="Clockwise"
                                            IsLargeArc="False"
                                            Point="150,5"/>
                            </PathFigure>
                        </PathGeometry>
                    </Path.Data>
                </Path>
            </Canvas>
            
            <!-- ===== 内环 (疲劳值) ===== -->
            <Canvas Width="300" Height="300">
                <!-- 内环轨道 -->
                <Ellipse x:Name="InnerTrackRing"
                         Width="260" Height="260"
                         Canvas.Left="20" Canvas.Top="20"
                         Stroke="{ThemeResource ControlStrongStrokeColorDefaultBrush}"
                         StrokeThickness="24"
                         Opacity="0.15"
                         Fill="Transparent"/>
                <!-- 内环进度弧 -->
                <Path x:Name="InnerArcPath"
                      Stroke="{x:Bind RingColor, Mode=OneWay}"
                      StrokeThickness="24"
                      StrokeStartLineCap="Round"
                      StrokeEndLineCap="Round"
                      Fill="Transparent">
                    <Path.Data>
                        <PathGeometry>
                            <PathFigure x:Name="InnerArcFigure" StartPoint="150,20">
                                <ArcSegment x:Name="InnerArcSegment"
                                            Size="130,130"
                                            SweepDirection="Clockwise"
                                            IsLargeArc="False"
                                            Point="150,20"/>
                            </PathFigure>
                        </PathGeometry>
                    </Path.Data>
                </Path>
            </Canvas>
            
            <!-- ===== 中心内容 ===== -->
            <!-- 单环模式：疲劳值 + 建议 -->
            <StackPanel x:Name="SingleRingContent"
                        VerticalAlignment="Center" HorizontalAlignment="Center"
                        Spacing="0"
                        Visibility="{x:Bind SingleModeVisibility, Mode=OneWay}">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock x:Name="ValueText"
                               FontSize="72" 
                               FontWeight="Bold"
                               FontFamily="Segoe UI Variable Display"/>
                    <TextBlock Text="%" 
                               FontSize="28" 
                               VerticalAlignment="Bottom"
                               Margin="2,0,0,14"
                               Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                               FontFamily="Segoe UI Variable Display"/>
                </StackPanel>
                <TextBlock x:Name="SuggestionText"
                           Text="{x:Bind Suggestion, Mode=OneWay}"
                           FontSize="14"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           Opacity="0.8"/>
            </StackPanel>
            
            <!-- 双环模式：倒计时 + 任务名 -->
            <StackPanel x:Name="DualRingContent"
                        VerticalAlignment="Center" HorizontalAlignment="Center"
                        Spacing="4"
                        Visibility="{x:Bind DualModeVisibility, Mode=OneWay}">
                <!-- 倒计时 -->
                <TextBlock x:Name="CountdownText"
                           Text="{x:Bind FocusCountdownText, Mode=OneWay}"
                           FontSize="48" 
                           FontWeight="Bold"
                           FontFamily="Segoe UI Variable Display"
                           HorizontalAlignment="Center"/>
                <!-- 任务名 -->
                <TextBlock x:Name="TaskNameText"
                           Text="{x:Bind FocusTaskName, Mode=OneWay}"
                           FontSize="14"
                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"
                           MaxWidth="180"
                           TextTrimming="CharacterEllipsis"/>
                <!-- 小字疲劳值 -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Opacity="0.6">
                    <TextBlock Text="疲劳 " FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                    <TextBlock x:Name="SmallFatigueText" FontSize="12" Foreground="{x:Bind RingColor, Mode=OneWay}"/>
                    <TextBlock Text="%" FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>
            </StackPanel>
            
            <!-- Care Mode 指示器 -->
            <Border x:Name="CareIndicator"
                    Width="36" Height="36"
                    CornerRadius="18"
                    Background="#FF8C00"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="0,10,10,0"
                    Visibility="{x:Bind IsCareMode, Mode=OneWay}">
                <FontIcon Glyph="&#xEB51;" FontSize="18" Foreground="White"
                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
            </Border>
        </Grid>
    </Viewbox>
</UserControl>
